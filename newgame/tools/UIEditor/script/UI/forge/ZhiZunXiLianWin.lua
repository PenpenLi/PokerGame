-- ZhiZunXiLianWin.lua-- created by hcl on 2013-8-5-- 至尊洗炼界面super_class.ZhiZunXiLianWin(NormalStyleWindow)local _target_item_data = nillocal _cur_select = nilfunction ZhiZunXiLianWin:show( user_item ,item_series)    local win = UIManager:show_window("zhizunxilian_win");    if ( win ) then         win:init_with_args( user_item )        win.curr_user_item = user_item;        win.item_series = item_series;    end    win:update("equip", item_series )endfunction ZhiZunXiLianWin:__init(  )    local _self_size = self.view:getSize()    self._not_show_next = false;    -- 上面九宫格背景   -- MUtils:create_zximg(self.view,UIResourcePath.FileLocate.common .. "nine_grid_bg3.png",32,322,724,74,500,500);   local t_bg = ZImage:create( self.view, UILH_COMMON.bottom_bg, 15, 75, 670, 490, nil, 600, 600 )   local t_bg_bg = ZImage:create( t_bg, "", 10, 565 - 155, 658, 145, nil, 600, 600 )   ZImage:create( t_bg_bg, UILH_COMMON.split_line_v, 140, 12, 3, 120 )   ZImage:create( self.view, UILH_COMMON.split_line, 25, 410, 645, 3 )   -- ZImage:create( self.view, UILH_COMMON.split_line, 25, 80, 645, 3 )   self._target_item = MUtils:create_equip_slotItem( nil, 60, 470, 64, 64, UIPIC_FORGE_029 )    self.view:addChild( self._target_item.view )   self._target_item.view:setScale( 68 / 60 )   self._target_item:set_icon_bg_texture( UILH_COMMON.slot_bg, -9, -9, 83, 83)   self._item_name = ZLabel:create( self.view, "dfd", 60, 440 )   local function slot_fun( ... )        if _target_item_data then            local a, b, arg = ...            local position = Utils:Split(arg,":");                -- 将相对坐标转化成屏幕坐标(即OpenGL坐标 800x480)            local pos = self._target_item.view:convertToWorldSpace( CCPointMake(position[1],position[2]) );            --ForgeModel:show_item_tips( slotItem.item_id, pos.x, pos.y )            local user_item = ItemModel:get_item_by_series( _target_item_data.item_series )            TipsModel:show_tip( pos.x, pos.y,user_item )        end    end    self._target_item:set_click_event(slot_fun)    -- 关闭按钮    -- local but_close = CCNGBtnMulTex:buttonWithFile( 340 + 389 - 33, 377, -1, -1, UIResourcePath.FileLocate.common .. "close_btn_z.png")    -- local exit_btn_size = but_close:getSize()    -- local spr_bg_size = self.view:getSize()    -- but_close:setPosition( spr_bg_size.width - exit_btn_size.width, spr_bg_size.height - exit_btn_size.height )    -- but_close:addTexWithFile(CLICK_STATE_DOWN, UIResourcePath.FileLocate.common .. "close_btn_z.png")	local function but_close_fun()		--if eventType == TOUCH_CLICK then            if ( self.is_tihuan == false ) then                local function fun()                    UIManager:hide_window( "zhizunxilian_win" )                    UIManager:show_window("forge_win");                end    			NormalDialog:show("确定放弃未替换的洗炼属性？",fun)            else                UIManager:hide_window( "zhizunxilian_win" )                UIManager:show_window("forge_win");            end            _target_item_data = nil			--NormalDialog:show(LangGameString[1039],fun) -- [1039]="确定放弃未替换的洗练属性？"        -- else        --     UIManager:hide_window( "zhizunxilian_win" )        --     UIManager:show_window("forge_win");        --end    end    self:setExitBtnFun(but_close_fun)    --self.exit_btn:setTouchClickFun(but_close_fun);    local function tihuan_fun()       -- if ( eventType == TOUCH_CLICK ) then       print("_cur_select",_cur_select)        if _cur_select then            self:send_request_upgrade( 8 ,1,{_cur_select - 1});        end        --end        --return true;    end    local tihuan_btn = ZTextButton:create( self.view, Lang.forge.tab_vip_xilian[1], UILH_COMMON.btn4_nor, tihuan_fun, _self_size.width / 2 - 150, 20 )    --MUtils:create_btn_and_lab(sub_panel_view_table.panel,UILH_COMMON.dg_sel_1, UILH_COMMON.dg_sel_2,tihuan_fun,47.5,17,80,32,LangGameString[1042],16); -- [1042]="替换"    -- 当前属性    --MUtils:create_sprite(self.view,UIResourcePath.FileLocate.forge .. "s_dqsx.png",62,358);    -- 批量刷新按钮    local function but_1_fun(eventType,x,y)        -- if eventType == TOUCH_CLICK then         local function fun()            local money = EquipEnhanceConfig:get_xl_need_money( self.lock_num ) * 8;            if PlayerAvatar:check_is_enough_money(4,money) then                 if _not_show_next then                    local param_arr = {};                    -- 是否至尊洗炼,1代表是                    param_arr[1] = 1;                    for i=1,3 do                        param_arr[i+1] = self.is_lock_table[i]                    end                    self:send_request_upgrade( 7 ,4,param_arr );                    self.is_tihuan = false;                else                    local function swith_but_func(not_show_next)                        _not_show_next = not_show_next                    end                    local function temp_fun()                        local param_arr = {};                        -- 是否至尊洗炼,1代表是                        param_arr[1] = 1;                        for i=1,3 do                            param_arr[i+1] = self.is_lock_table[i]                        end                        self:send_request_upgrade( 7 ,4,param_arr );                        self.is_tihuan = false;                    end                    ConfirmWin2:show( 5, nil, string.format(Lang.forge.tab_vip_xilian[3],money), temp_fun , swith_but_func )                end                --ConfirmWin( "select_confirm", nil, string.format(Lang.forge.tab_vip_xilian[3],money), temp_fun, nil, 450, nil)            end        end        self:is_have_max_attr_not_lock( fun )        -- return true        -- end        -- return true    end    local xilian_btn = ZTextButton:create( self.view, Lang.forge.tab_vip_xilian[2], UILH_COMMON.btn4_nor, but_1_fun, _self_size.width / 2 + 30, 20 )    --xilian_btn:setTouchClickFun( but_1_fun)    -- local xilian_btn = MUtils:create_btn( self.view,UIResourcePath.FileLocate.common .. "tishi_button.png",UIResourcePath.FileLocate.common .. "tishi_button.png", but_1_fun,610,350,120,41,1,39,19,39,19,39,19,39,19)    -- MUtils:create_sprite(xilian_btn,UIResourcePath.FileLocate.forge .. "plxl_btn1.png",60,20.5)    self.lab_need_money = MUtils:create_zxfont(self.view,LangGameString[1040],_self_size.width - 180,35,1,14); -- [1040]="刷新消耗0元宝"    self.attr_view_table = {};    self.lock_view_table = {};    self.is_lock_table = {0,0,0};    self.is_max_attr_table = { false,false,false };    -- 当前的属性    for i=1,3 do        local x = 205 + (i-1)*156        local y = 515 ;        self.attr_view_table[i] = MUtils:create_zxfont(self.view,LangGameString[1041],x ,y,1,16); -- [1041]="未激活"        -- 是否锁定        local function use_shield_fun( is_lock )       --     print("use_shield_fun( is_lock )",is_lock,self.lock_num);            if ( is_lock ) then                self.is_lock_table[i] = 1;                self.lock_num = self.lock_num + 1;                -- 更新需要的金钱label                self:update_need_money_label()                if ( self.lock_num == self.curr_user_item.smith_num-1 ) then                    for j=1,3 do                        if ( self.is_lock_table[j] == 0 ) then                            self.lock_view_table[j].view:setIsVisible(false);                            break;                        end                    end                end            else                self.is_lock_table[i] = 0;                self.lock_num = self.lock_num - 1;                -- 更新需要的金钱label                self:update_need_money_label()                if ( self.lock_num < self.curr_user_item.smith_num-1 ) then                    for j=1,3 do                        if ( j~=i and self.is_lock_table[j] == 0 ) then                            self.lock_view_table[j].view:setIsVisible(true);                            break;                        end                    end                end            end        end        self.lock_view_table[i] = UIButton:create_switch_button(x,y-55, 80, 35, UILH_COMMON.dg_sel_1, UILH_COMMON.dg_sel_2, LangGameString[665], 45, 14, nil, nil, nil, nil, use_shield_fun ) -- [665]="锁定"        self.view:addChild(self.lock_view_table[i].view,2);       -- self.lock_view_table[i].view:setIsVisible(false);    end    -- 1-8 8个属性的总panel 9-16     self.update_view = {}    -- 下面的八个背景    for i=1,8 do        local x = 25 + (i-1)%4*163;        local y = 247 - math.floor((i-1)/4) *158;                MUtils:create_zximg(self.view, UILH_COMMON.bg_03,x,y,160,150,500,500);        local sub_panel_view_table = {};        sub_panel_view_table.panel = CCBasePanel:panelWithFile( x, y, 165,150, nil,0,0)        self.view:addChild(sub_panel_view_table.panel);        sub_panel_view_table[1] = MUtils:create_zxfont(sub_panel_view_table.panel,LangGameString[1041],77.5 ,120,2,14); -- [1041]="未激活"        sub_panel_view_table[2] = MUtils:create_zxfont(sub_panel_view_table.panel,LangGameString[1041],77.5 ,90,2,14); -- [1041]="未激活"        sub_panel_view_table[3] = MUtils:create_zxfont(sub_panel_view_table.panel,LangGameString[1041],77.5 ,60,2,14); -- [1041]="未激活"        local function select_function(eventType)            if eventType == TOUCH_CLICK then                _cur_select = i                for i = 1, #self.update_view do                    if i == _cur_select then                        self.update_view[i][4].set_state( true )                    else                        self.update_view[i][4].set_state( false )                    end                end            end            print("run select_function _cur_select",_cur_select)            return true        end        sub_panel_view_table.panel:registerScriptHandler(select_function)        local function select_function_t(eventType)            --if eventType == TOUCH_CLICK then                _cur_select = i                for i = 1, #self.update_view do                    if i == _cur_select then                        self.update_view[i][4].set_state( true )                    else                        self.update_view[i][4].set_state( false )                    end                end            --end            print("run select_function _cur_select",_cur_select)           -- return true        end               sub_panel_view_table[4] = UIButton:create_switch_button( 60, 10, 80, 35, UILH_COMMON.dg_sel_1, UILH_COMMON.dg_sel_2, "", 45, 14, nil, nil, nil, nil, select_function_t ) -- [665]="锁定"        sub_panel_view_table.panel:addChild( sub_panel_view_table[4].view )        -- local function tihuan_fun( eventType,arg,msgid)        --     if ( eventType == TOUCH_CLICK ) then        --         self:send_request_upgrade( 8 ,1,{i-1});        --     end        --     return true;        -- end        -- MUtils:create_btn_and_lab(sub_panel_view_table.panel,UILH_COMMON.dg_sel_1, UILH_COMMON.dg_sel_2,tihuan_fun,47.5,17,80,32,LangGameString[1042],16); -- [1042]="替换"        self.update_view[i] = sub_panel_view_table;    endendfunction ZhiZunXiLianWin:init_with_args( user_item )    -- 设置洗炼属性    for i=1,3 do        if ( i<= user_item.smith_num ) then            local smith = user_item.smiths[i];            local str,is_max_attr = self:get_attr_str( smith.type,smith.value )            self.is_max_attr_table[i] = is_max_attr;            self.attr_view_table[i]:setText( str );            self.lock_view_table[i].set_state(false);            if ( user_item.smith_num >1 ) then                self.lock_view_table[i].view:setIsVisible(true);            else                self.lock_view_table[i].view:setIsVisible(false);            end        else            self.attr_view_table[i]:setText(LangGameString[1041]); -- [1041]="未激活"            self.lock_view_table[i].view:setIsVisible(false);            self.is_max_attr_table[i] = false;        end    end     self.lock_num = 0;    self.is_lock_table = {0,0,0};    -- self.is_max_attr_table = {false,false,false};    self:update_need_money_label();    -- 隐藏下面的所有数据    for i=1,8 do        self.update_view[i].panel:setIsVisible(false);    end    self.piliang_attr_max = false;  --批量属性里面是否有新的满属性    self.is_tihuan = true;          --是否已经替换满属性endfunction ZhiZunXiLianWin:update_need_money_label()    local money = EquipEnhanceConfig:get_xl_need_money( self.lock_num ) * 8    self.lab_need_money:setText( LangGameString[1043]..money..LangGameString[414] ); -- [1043]="#cfff000手续费：" -- [414]="元宝"endfunction ZhiZunXiLianWin:is_have_max_attr_not_lock( fun )    for i=1,3 do        if ( self.is_max_attr_table[i] and self.is_lock_table[i] == 0 ) then            NormalDialog:show("当前洗炼属性中有满属性值没有锁定，继续洗炼很有可能丢失该属性，确认继续洗炼吗？",fun)            return;        end    end    if ( self.piliang_attr_max ) then        NormalDialog:show("新的洗炼属性中有满属性值没有替换，继续洗炼很有可能丢失该属性，确认继续洗炼吗？",fun)    else         fun();    endend-- 发送处理装备协议function ZhiZunXiLianWin:send_request_upgrade( do_type ,param_count,param_arr)    ForgeWin:set_if_waiting_result( true )    ForgeWin:set_if_waiting_reflash( true )    local item_count = 1                                                      -- 物品个数    local id_items   = { self.item_series}              -- 物品的序列号    local htype      = do_type                                                     -- 操作类型,装备提品                                      ItemCC:req_handle_item (item_count, id_items, htype, param_count, param_arr)    local user_item = ItemModel:get_item_in_bag_or_body( self.item_series )    print("user_item",self.item_series,user_item.item_id,user_item.series);endfunction ZhiZunXiLianWin:update_item(item_series)    local _target_item_data = ForgeModel:get_item_in_bag_or_body( item_series )    self._target_item.set_date( _target_item_data )    if _target_item_data then        local item_name = ForgeModel:get_item_name_with_color( _target_item_data.item_id )        self._item_name:setText( item_name )    endend-- 更新function ZhiZunXiLianWin:update( update_type, arg )    if ( update_type == "zzxl") then        self:update_attrs(arg);    elseif ( update_type == "th" ) then        self:update_th( arg[1] );    elseif update_type == "equip" then        self:update_item(arg)    endendfunction ZhiZunXiLianWin:update_attrs( arg )    self.piliang_attr_max = false;    for i=1,8 do        self.update_view[i].panel:setIsVisible(true);        for j=1,3 do            local smith = arg[i].attrs[j];            if ( smith.type ~= 0 ) then                local str,is_max_attr = self:get_attr_str( smith.type,smith.value )                self.update_view[i][j]:setText( str );                if ( is_max_attr and self.is_lock_table[j] == 0) then                    self.piliang_attr_max = true;                end            else                self.update_view[i][j]:setText(LangGameString[1041]); -- [1041]="未激活"            end        end    endendfunction ZhiZunXiLianWin:update_th( item_series )    self.item_series = item_series;    local user_item = ItemModel:get_item_in_bag_or_body( self.item_series )    -- 设置洗炼属性    for i=1,3 do        if ( i<= user_item.smith_num ) then            local smith = user_item.smiths[i];            local str,is_max_attr = self:get_attr_str( smith.type,smith.value )            self.is_max_attr_table[i] = is_max_attr;            self.attr_view_table[i]:setText( str );            --self.lock_view_table[i].view:setIsVisible(true);        else            --self.attr_view_table[i]:setText("未激活");            --self.lock_view_table[i].view:setIsVisible(false);            self.is_max_attr_table[i] = false;        end    end    self.piliang_attr_max = false;      -- 批量洗炼是否有满属性    self.is_tihuan = true;              -- 是否endfunction ZhiZunXiLianWin:get_attr_str( type,value )    local color ,is_max_attr = EquipEnhanceConfig:get_attr_color( type,value );    local str = color..staticAttriTypeList[type].."  +"..math.abs(value);    if ( is_max_attr ) then        str = str .. LangGameString[1046]; -- [1046]="(满)"    end     return str,is_max_attr;end