-- ZhaoCaiWin.lua -- created by fangjiehua on 2013-1-10-- 招财进宝系统窗口 super_class.ZhaoCaiWin(NormalStyleWindow)local _refWidth =  UIScreenPos.relativeWidthlocal zhaocai_text1 = nil;local huode_text1 = nil;local zhaocai_text2 = nil;local huode_text2 = nil;local zhaocai_btn  = nil;local btn_lab_1 = nil;local jinbao_btn  = nil;-- 招财1次需要的元宝数local _zhaocai_1_need_money = 0;-- 招财10次需要的元宝数local _zhaocai_10_need_money = 0;-- 进宝1次所需元宝local _jinbao_1_need_money  = 0local _jinbao_1_income 		= 0 --进宝一次的银两产出量-- 剩余次数local _zhaocai_remain_count = 0-- 进宝剩余次数local _jinbao_remain_count  = 0local _exit_btn_info = { img = UIPIC_COMMOM_008, z = 1000, width = 60, height = 60 }local win_info = {width = 340, height = 490}function ZhaoCaiWin:active( show )	if show == true then		--更新数据		self:update();		-- 暂时屏蔽特效		-- -- 播放招财的特效		-- LuaEffectManager:play_view_effect( 10003,194,214,self.view,true )	else		-- 暂时屏蔽特效		-- 停止招财的特效		-- LuaEffectManager:stop_view_effect( 10003,self.view )	endendfunction ZhaoCaiWin:update(  )	if VIPModel:get_vip_info().level >= 5 then		zhaocai_btn:setIsVisible(true);		zhaocai_text1.view:setIsVisible(true)		huode_text1.view:setIsVisible(true)		self.zhaocai_remain.view:setIsVisible(true)		jinbao_btn:setPosition(210,48);		zhaocai_text2:setPosition(275, 32)		huode_text2:setPosition(275, 10)		self.jinbao_remain.view:setPosition(265, 115)	else		zhaocai_text1.view:setIsVisible(false)		huode_text1.view:setIsVisible(false)		zhaocai_btn:setIsVisible(false)		self.zhaocai_remain.view:setIsVisible(false)		zhaocai_text2:setPosition(195, 32)		huode_text2:setPosition(195, 10)		jinbao_btn:setPosition(130,48);		self.jinbao_remain.view:setPosition(190, 115)	end   		--最大招财次数	local day_max_zc_num = ZhaoCaiModel:get_max_zhaocai_count(  );	_zhaocai_remain_count = ZhaoCaiModel:get_can_zhaocai_count()	if _zhaocai_remain_count > 0 then		local current_zc_num = ZhaoCaiModel:get_has_zc_num()+1; --这次招财是第几次招财		-- print("第",current_zc_num,"次招财",day_max_zc_num);		_zhaocai_1_need_money = ZhaoCaiModel:get_cost_yb_by_zhaocai_times(current_zc_num);		--招财需要多少元宝		zhaocai_text1:setText(string.format(Lang.zhaocai[1], _zhaocai_1_need_money)); -- [1]="#c33a6ee消耗#cffffff%d#c33a6ee元宝"		-- 剩余招财次数		local lave_count = ZhaoCaiModel:get_can_zhaocai_count();		self.zhaocai_remain:setText(string.format(Lang.zhaocai[9], lave_count))		local gain_money = ZhaoCaiModel:get_current_zhaocai_gain();		huode_text1:setText(string.format(Lang.zhaocai[2],gain_money)); -- "#cfff000换#cffffff%d#cfff000银两"		-- zhaocai_text_1:setText(string.format(LangGameString[2287],_lave_count)); -- [2287]="#c33a6ee今日还可以招财#cfff000%d#c33a6ee次"		zhaocai_btn:setCurState(CLICK_STATE_UP)	else		self.zhaocai_remain:setText(string.format(Lang.zhaocai[9], 0))		zhaocai_btn:setCurState(CLICK_STATE_DISABLE);		zhaocai_text1.view:setIsVisible(false)		huode_text1.view:setIsVisible(false)	end	--最大进宝次数	local day_max_jb_num = ZhaoCaiModel:get_max_jinbao_count(  )	_jinbao_remain_count = ZhaoCaiModel:get_can_jinbao_count()	if _jinbao_remain_count > 0 then		local current_jb_num = ZhaoCaiModel:get_has_jinbao_num()+1; --这次招财是第几次招财		-- print("第",current_zc_num,"次招财",day_max_zc_num);		_jinbao_1_need_money = ZhaoCaiModel:get_cost_yb_by_jinbao_times(current_jb_num);		--招财需要多少元宝		zhaocai_text2:setText(string.format(Lang.zhaocai[1], _jinbao_1_need_money)); -- #cfff000消耗#cffffff%d#cfff000元宝		-- 剩余进宝次数		local lave_count = ZhaoCaiModel:get_can_jinbao_count();		self.jinbao_remain:setText(string.format(Lang.zhaocai[9], lave_count))		local gain_money = ZhaoCaiModel:get_current_jinbao_gain();		huode_text2:setText(string.format(Lang.zhaocai[6],gain_money)); -- "#cfff000换#cffffff%d#cfff000铜币	else		self.jinbao_remain:setText(string.format(Lang.zhaocai[9], 0))		jinbao_btn:setCurState(CLICK_STATE_DISABLE);		zhaocai_text2.view:setIsVisible(false)		huode_text2.view:setIsVisible(false)	endend-- 招财的事件function ZhaoCaiWin:zhaocai_event( times )	ZhaoCaiModel:req_zhaocai_1( _zhaocai_1_need_money, _zhaocai_remain_count )end--点击按钮请求进宝function ZhaoCaiWin:jinbao_event ()	ZhaoCaiModel:req_jinbao_1( _jinbao_1_need_money, _jinbao_remain_count )endfunction ZhaoCaiWin:initPanel( self_panel ) 	-- 添加一个九宫格底板	local panel = CCBasePanel:panelWithFile( 15, 100, 351, 333,UILH_COMMON.bottom_bg,500,500)	self_panel:addChild(panel)    --底部颜色    -- local zhaocai_ds = CCZXImage:imageWithFile(389/2-376/2,7,376,380,UIResourcePath.FileLocate.zhaoCai .. "grounding.png",500,500)    -- self_panel:addChild(zhaocai_ds)    --bg    local zhaocai_bg = CCZXImage:imageWithFile(4,3,-1,-1,UILH_ZHAOCAI.zhaocai_icon);    panel:addChild(zhaocai_bg);    --    -- zhaocai_text = CCZXLabel:labelWithTextS(CCPointMake(457/2, 20), "abcd",16,ALIGN_CENTER); -- [2292]="#33a6ee使用#cfff00080元宝#33a6ee可以招财1次,获得#cfff00015000#33a6ee仙币"    zhaocai_text1 = ZLabel:create(self_panel, "", 105, 32, 15, ALIGN_CENTER)    huode_text1 = ZLabel:create(self_panel, string.format(Lang.zhaocai[2], 15000), 105, 10, 15, ALIGN_CENTER)    zhaocai_text2 = ZLabel:create(self_panel, "", 245, 32, 15, ALIGN_CENTER)    huode_text2 = ZLabel:create(self_panel, string.format(Lang.zhaocai[6], 15000), 245, 10, 15, ALIGN_CENTER)    self.zhaocai_remain = ZLabel:create(self_panel, "", 100, 115, 15, ALIGN_CENTER)    self.jinbao_remain = ZLabel:create(self_panel, "", 245, 115, 15, ALIGN_CENTER)	    --招财一次	local function zhaocai_1_event( eventType )		if eventType == TOUCH_CLICK then			self:zhaocai_event( )		end		return true	end    -- 招财1次	zhaocai_btn = CCNGBtnMulTex:buttonWithFile(40,48,-1,-1,UILH_COMMON.btn4_nor);	zhaocai_btn:addTexWithFile(CLICK_STATE_DOWN,UILH_COMMON.btn4_nor);   	zhaocai_btn:addTexWithFile(CLICK_STATE_MOVE,UILH_COMMON.btn4_nor);   	zhaocai_btn:addTexWithFile(CLICK_STATE_DISABLE,UILH_COMMON.btn4_dis)	self_panel:addChild(zhaocai_btn);	zhaocai_btn:registerScriptHandler(zhaocai_1_event);	-- 按钮文字	btn_lab_1 = ZLabel:create(zhaocai_btn, Lang.zhaocai[3], 121/2, 20, 16, ALIGN_CENTER);	-- btn_lab_1:setAnchorPoint(0.5,0.5);	-- zhaocai_btn:addChild(btn_lab_1);	--招财10次	-- local function zhaocai_10_event( eventType )	-- 	if eventType == TOUCH_CLICK then	-- 		self:zhaocai_event( 10 )	-- 	end	-- 	return true	-- end	-- 进宝	local function jinbao_1_event( eventType )		if eventType == TOUCH_CLICK then			self:jinbao_event( )		end		return true	end	--进宝	jinbao_btn = CCNGBtnMulTex:buttonWithFile(105,48,-1,-1,UILH_COMMON.btn4_nor);	jinbao_btn:addTexWithFile(CLICK_STATE_DOWN,UILH_COMMON.btn4_nor);   	jinbao_btn:addTexWithFile(CLICK_STATE_MOVE,UILH_COMMON.btn4_nor);   	jinbao_btn:addTexWithFile(CLICK_STATE_DISABLE,UILH_COMMON.btn4_dis)	self_panel:addChild(jinbao_btn);	jinbao_btn:registerScriptHandler(jinbao_1_event);	-- 按钮文字	btn_lab_2 =  ZLabel:create(jinbao_btn, Lang.zhaocai[4], 121/2, 20, 16, ALIGN_CENTER);endfunction ZhaoCaiWin:__init( window_name, texture_name, grid, width, height, title_text )	--第一层背景 	-- ZImage:create( self.view, UIPIC_GRID_BOTTOM_BG, 0, 0, win_info.width, win_info.height, -1 )	-- --第二层背景	-- local bg = ZImage:create( self.view, UIPIC_COMMOM_style_bg, 0, 0, win_info.width, win_info.height - 25, -1 )	-- local out_grid = ZImage:create( self.view, UIPIC_COMMOM_006, 0, 0, win_info.width, win_info.height - 25, nil, 600, 600 )	--  --标题背景	-- local title_bg = ZImage:create( self.view, UIPIC_COMMOM_title_bg, 0, 0, -1, 60 )	-- local title_bg_size = title_bg:getSize()	-- title_bg:setPosition( ( width - title_bg_size.width ) / 2, win_info.height - title_bg_size.height )    	-- local t_width = title_bg:getSize().width	-- local t_height = title_bg:getSize().height	-- local window_title = ZImage:create(title_bg, title_text , t_width/2,  t_height-27, -1,-1,999 );	-- window_title.view:setAnchorPoint(0.5,0.5)	       --关闭按钮	-- local function _close_btn_fun()	-- 	UIManager:hide_window("zhaocai_win")	-- end	-- self._exit_btn = ZButton:create(self.view, _exit_btn_info.img, _close_btn_fun,0,0,_exit_btn_info.width,_exit_btn_info.height,_exit_btn_info.z);	-- --self._exit_btn:setAnchorPoint(0.5,0.5)	-- local exit_btn_size = self._exit_btn:getSize()	-- self._exit_btn:setPosition( win_info.width - exit_btn_size.width , win_info.height - exit_btn_size.height)	self:initPanel(self.view)end----------------------招财回调-----------function ZhaoCaiWin:do_zhaocai_callback(  )	local gain_money = ZhaoCaiModel:get_current_gain1(); 	GlobalFunc:create_screen_notic( string.format(Lang.zhaocai[2],gain_money), 14, _refWidth(1.0)/2, 240) -- [8]="获得15000银两" 	-- 暂时屏蔽特效 	--LuaEffectManager:play_view_effect( 10004,194,214,self.view,false );endfunction ZhaoCaiWin:do_jinbao_callback()	local gain_money = ZhaoCaiModel:get_current_gain2(); 	GlobalFunc:create_screen_notic( string.format(Lang.zhaocai[6],gain_money), 14, _refWidth(1.0)/2, 240); -- [7]="获得15000铜币"end 