-- MallWin.lua  -- created by lyl on 2012-2-17-- 商城系统  mall_winsuper_class.MallWin(NormalStyleWindow);require "utils/UI/UILabel"require "UI/mall/MallItemList"require "model/MallModel"-- 数字与 类型名称 的映射--local _index_to_category_name = { [1] = "hot", [2] = "common", [3] = "stone", [4] = "pet", [5] = "binding_gold" }local _index_to_category_name = { [1] = "hot", [2] = "common",  [3] = "individuality", [4] = "stone", [5] = "pet", [6] = "huanqing", [7]="binding_gold"  }-- uilocal win_width = 900local win_height = 555local base_panel_x = 30local base_panel_y = 20local panel_beg_x = 155local panel_bttm_h = 65local panel_up_h = 450local panel_w = 715local align_bttm = 10-- Langlocal txt_lang_info = Lang.mall_info-- 商城系统对象初始化function MallWin:__init( window_name, window_info )    local bgPanel = self.view    self.but_name_t = {}      -- 每个按钮的名称有两种状态，存储该名称图片，改变图片    self.effect_sprite = nil    -- 大背景    self.bg_main = CCBasePanel:panelWithFile( 150, 10, 740, 525, UILH_COMMON.normal_bg_v2, 500, 500)    self.view:addChild( self.bg_main )    -- 添加背景底框    local bg =  CCBasePanel:panelWithFile( panel_beg_x+7, panel_bttm_h+align_bttm, panel_w, panel_up_h, UILH_COMMON.bottom_bg, 500, 500)    bgPanel:addChild(bg)    -- the girt     ZImage:create( self.bg_main, "nopack/girl.png", -333, -15, -1, -1)    -- 添加底部背景框    -- local bg_bttm = CCBasePanel:panelWithFile( panel_beg_x, align_bttm, panel_w, panel_bttm_h, UILH_COMMON.bottom_bg, 500, 500)    -- bgPanel:addChild(bg_bttm)    -- 顶部所有按钮    local but_beg_x =150         --按钮起始x坐标    local but_beg_y = 527         --按钮起始y坐标    local but_int_x = 102          --按钮x坐标间隔    local but_int_hight=44        --按钮高度    local but_int_wildth=101       --按钮宽度    local btn_num = 7    local btn_idx = 1    self.radio_buts = CCRadioButtonGroup:buttonGroupWithFile(but_beg_x+10 ,but_beg_y , but_int_x * btn_num, but_int_hight,nil)    bgPanel:addChild( self.radio_buts )    self:create_a_button(self.radio_buts, 1 + but_int_x * (btn_idx - 1), 1, but_int_wildth, but_int_hight,        UILH_COMMON.tab_gray,       UILH_COMMON.tab_light,        txt_lang_info[17],       UIPIC_MALLWIN_101,        UIPIC_MALLWIN_102, btn_idx)    btn_idx = btn_idx + 1    self:create_a_button(self.radio_buts, 1 + but_int_x * (btn_idx - 1), 1, but_int_wildth, but_int_hight,        UILH_COMMON.tab_gray,       UILH_COMMON.tab_light,        txt_lang_info[18],       UIPIC_MALLWIN_103,       UIPIC_MALLWIN_104,  btn_idx)    btn_idx = btn_idx + 1    self:create_a_button(self.radio_buts, 1 + but_int_x * (btn_idx - 1), 1, but_int_wildth, but_int_hight,        UILH_COMMON.tab_gray,       UILH_COMMON.tab_light,        txt_lang_info[19],       UIPIC_MALLWIN_105,       UIPIC_MALLWIN_106,  btn_idx)    btn_idx = btn_idx + 1    self:create_a_button(self.radio_buts, 1 + but_int_x * (btn_idx - 1), 1, but_int_wildth, but_int_hight,         UILH_COMMON.tab_gray,        UILH_COMMON.tab_light,         txt_lang_info[20],        UIPIC_MALLWIN_107,         UIPIC_MALLWIN_108, btn_idx)    btn_idx = btn_idx + 1    self:create_a_button(self.radio_buts, 1 + but_int_x * (btn_idx - 1), 1, but_int_wildth, but_int_hight,         UILH_COMMON.tab_gray,        UILH_COMMON.tab_light,         txt_lang_info[21],         UIPIC_MALLWIN_109,          UIPIC_MALLWIN_110,  btn_idx)    btn_idx = btn_idx + 1    self:create_a_button(self.radio_buts, 1 + but_int_x * (btn_idx - 1), 1, but_int_wildth, but_int_hight,         UILH_COMMON.tab_gray,        UILH_COMMON.tab_light,         txt_lang_info[24],  -- 欢庆道具        UIPIC_MALLWIN_112,         UIPIC_MALLWIN_112,  btn_idx)    btn_idx = btn_idx + 1    self:create_a_button(self.radio_buts, 1 + but_int_x * (btn_idx - 1), 1, but_int_wildth, but_int_hight,         UILH_COMMON.tab_gray,        UILH_COMMON.tab_light,         txt_lang_info[22],        UIPIC_MALLWIN_112,         UIPIC_MALLWIN_112,  btn_idx)    -- 销售列表    self.mall_item_list = MallItemList:create(  )    self.mall_item_list:setPosition(base_panel_x, base_panel_y)    bgPanel:addChild( self.mall_item_list.view )    local switch_btn_func = function(  )        if _only_use_yb_btn then            MallModel:set_only_use_yb( _only_use_yb_btn.if_selected )        end    end    _only_use_yb_btn = UIButton:create_switch_button(50, 30, 140, 40,         UIPIC_FORGE_031,         UIPIC_FORGE_032,         txt_lang_info[12], 43, 16, nil, nil, nil, nil,         switch_btn_func )    bgPanel:addChild(_only_use_yb_btn.view, 2);    _only_use_yb_btn.view:setIsVisible(false)    -- local yuanbao_x = 50    -- local lijuan_x = 250    local gold_tile= UILabel:create_lable_2( LH_COLOR[2] .. txt_lang_info[4],  panel_beg_x+20, 35+3+2+20-15, 16, ALIGN_LEFT ) -- [1479]="#cffff00元宝" 255+76-50    bgPanel:addChild( gold_tile )    self.gold_lable = UILabel:create_lable_2( LH_COLOR[15] .. "0",  panel_beg_x+20+50, 35+3+2+20-15, 16, ALIGN_LEFT )    bgPanel:addChild( self.gold_lable )    local tile_inv = 200    local bangding_gold_tile= UILabel:create_lable_2( LH_COLOR[2] .. txt_lang_info[5], panel_beg_x+tile_inv+20, 35+3+2+20-15, 16, ALIGN_LEFT ) -- [1480]="#cffff00礼券"    bgPanel:addChild( bangding_gold_tile )    self.bangding_gold = UILabel:create_lable_2( LH_COLOR[15] .. "0", panel_beg_x+tile_inv+20+50, 35+3+2+20-15, 16, ALIGN_LEFT ) -- [1480]="#cffff00礼券：999999999"    bgPanel:addChild( self.bangding_gold )    -- 更新元宝和礼券    self:update_gold()    self:update_binding_gold()    -- 充值    local function recharge_but_CB( eventType )        if eventType == TOUCH_CLICK then            GlobalFunc:chong_zhi_enter_fun()        end        return true;    end    local get_award_btn = MUtils:create_btn( bgPanel,         UILH_NORMAL.special_btn,  -- 165,53        UILH_NORMAL.special_btn,        recharge_but_CB,         685, 22, -1, -1)    MUtils:create_zximg(get_award_btn, UILH_MALL.chongzhi, 60, 15, -1, -1);    MallModel:request_time_limit_item(  ) -- 限制产品end-- 创建一个按钮:参数： 要加入的panel， 坐标和长宽，按钮两种状态背景图，显示文字图片，文字图片的长宽，序列号（用于触发事件判断调用的方法）function MallWin:create_a_button(panel, pos_x, pos_y, size_w, size_h, image_n, image_s, but_name_txt,but_name_n, but_name_s, but_index)    local radio_button = CCRadioButton:radioButtonWithFile(pos_x, pos_y, size_w, size_h, image_n)    radio_button:addTexWithFile(CLICK_STATE_DOWN,image_s)    --按钮显示的图片名称    -- 按钮label 名称    local btn_name = UILabel:create_lable_2( but_name_txt, 101*0.5, 10, 16, ALIGN_CENTER )    radio_button:addChild(btn_name)	local function but_1_fun(eventType,x,y)        if eventType ==  TOUCH_BEGAN then            return true        elseif eventType == TOUCH_CLICK then            --根据序列号来调用方法            self.mall_item_list:Choose_panel( _index_to_category_name[but_index] )            for key, but_name in pairs(self.but_name_t) do                but_name.change_to_no_selected()            end            -- 切换页面时修正指引特效            self:xszy_change_page(but_index)            -- 添加商城打点            Analyze:parse_click_mall(but_index)            return true;        elseif eventType == TOUCH_ENDED then            return true;        end	end    radio_button:registerScriptHandler(but_1_fun)    --注册    panel:addGroup(radio_button)end-- 创建按钮的名称（需要控制两种状态）function MallWin:create_but_name( but_name_n, but_name_s )	local but_name = CCZXImage:imageWithFile( 0, 0, -1, -1, but_name_n )    local but_name_script = {}	but_name_script.change_to_selected = function (  )		but_name:setTexture( but_name_s )	end	but_name_script.change_to_no_selected = function (  )		but_name:setTexture( but_name_n )	end    but_name_script.view = but_name	return but_name_scriptend-- 提供外部调用更新的静态方法function MallWin:update_mall_win( update_type )    local win = UIManager:find_visible_window( "mall_win" )    if win ~= nil then        win:update( update_type )    endend-- 更新function MallWin:update( update_type )    if update_type == "yuanbao" then        self:update_gold(  )    elseif update_type == "bindYuanbao" then        self:update_binding_gold(  )    elseif update_type == "all" then        self:update_gold(  )        self:update_binding_gold(  )    else        self.mall_item_list:update( update_type )    endend-- 更新元宝function MallWin:update_gold(  )    local gold_num = MallModel:get_player_gold(  ) or 0    -- self.gold_lable:setString( LangGameString[1481]..gold_num ) -- [1481]="#cffff00元宝："    self.gold_lable:setString(LH_COLOR[15] .. gold_num ) -- [1481]="#cffff00元宝："end-- 更新绑定元宝function MallWin:update_binding_gold(  )    local gold_num = MallModel:get_player_binding_gold(  ) or 0    -- self.bangding_gold:setString( LangGameString[1482]..gold_num ) -- [1482]="#cffff00礼券："     self.bangding_gold:setString(LH_COLOR[15] .. gold_num ) -- [1482]="#cffff00礼券：end-- 切换页function MallWin:change_page( page_index )    print("MallWin:change_page",page_index)    self.mall_item_list:Choose_panel( _index_to_category_name[page_index] )    -- for key, but_name in pairs(self.but_name_t) do    --     but_name.change_to_no_selected()    -- end    -- self.but_name_t[page_index].change_to_selected()    self.radio_buts:selectItem( page_index - 1)    self:xszy_change_page(page_index)endfunction MallWin:active( show )    self:update("all")    -- 新手指引代码    if ( show == false and self.is_xszy ) then         self.is_xszy = false;        -- 去掉选中中级强化石的特效        LuaEffectManager:stop_view_effect( 10010,self.view )        self.effect_sprite = nil    end    if show then        local flag = MallModel:get_only_use_yb(  )        if _only_use_yb_btn then            _only_use_yb_btn.set_state(flag, true)        end    endendfunction MallWin:destroy()    if self.mall_item_list  then        self.mall_item_list:destroy()    end    -----------HJH    -----------2013-3-18    -----------补上DESTROY方法    if (self.is_xszy and self.is_xszy == true) then         self.is_xszy = false;        -- 去掉选中中级强化石的特效        LuaEffectManager:stop_view_effect( 10010,self.view )        self.effect_sprite = nil    end    Window.destroy(self)end-- 新手指引代码 ，从极品三套装界面打开的商城要自动切换到热销商品页，-- 然后在中级强化石那里播放选中特效function MallWin:show_xszy()    local win = UIManager:show_window("mall_win");    if ( win ) then        win.mall_item_list:Choose_panel( "hot" );        win.radio_buts:selectItem(0);        win.is_xszy = true;        if win.effect_sprite == nil then            local sprite = LuaEffectManager:play_view_effect( 10010,277,448,win.view,true,5)            sprite:setScaleX(1.1)            sprite:setScaleY(1.4)            win.effect_sprite = sprite        end        -- local c = callback:new()        -- c:start(0.75, function()        --     MallModel:show_buy_keyboard( 18711, "hot", 99 )        -- end)    endend-- 切换分页时调用的方法，用于修改极品装备的特效function MallWin:xszy_change_page(page_index)    if (self.is_xszy and self.is_xszy == true) then         if page_index == 1 then            if self.effect_sprite == nil then                local sprite = LuaEffectManager:play_view_effect( 10010,277,448,self.view,true,5)                sprite:setScaleX(1.1)                sprite:setScaleY(1.4)                self.effect_sprite = sprite;            end        else            LuaEffectManager:stop_view_effect( 10010,self.view )            self.effect_sprite = nil        end    endend